---
title: "BD_BIDS_Converter"
author: "Niklas Wulms"
date: "7/4/2019"
output: html_document
---

#### optional: libraries to install

```{r eval=FALSE}
install.packages("stringr")
install.packages("tidyverse")
install.packages("devtools")
devtools::install_github("muschellij2/dcm2niir")
```

```{r eval=FALSE}
install_dcm2nii(lib.loc=NULL, overwrite = FALSE, from_source = TRUE, jpeg = FALSE, progdir = NULL)
```

#### load libraries

```{r}
library(stringr)
library(tidyr)
library(devtools)
library(dcm2niir)
library(stringi)
library(dplyr)
```



# set here your start folder

```{r}
working_dir <- ("/media/niklas/spaceC/BIDS_Convert_test") 
```

Working directory is set here

```{r setup}
require(knitr)
knitr::opts_knit$set(root.dir = working_dir)

```


#### creation of output folders

```{r}
dir.create("nii_temp")
dir.create("nii")
```

#### Indexing of dicom images

compare which folders are done and which are not done.

We need to identify combinations of _timepoint x subject_id_ out of the folder _dicom_ and _nii_

```{r}
dicoms <- dir("dicom", full.names = TRUE)

dicoms <- unlist(lapply(dicoms, FUN = dir, 
                 recursive = FALSE, 
                 full.names = TRUE)) 
```



```{r}
# converted dicoms rausfiltern auslesen!
if (file.exists("dcm_converted.txt") == 1) {
  print("Reading in already converted dicom files")
  dicoms_done <- read.table("dcm_converted.txt", stringsAsFactors = FALSE)
  dicoms_to_process <- setdiff(dicoms, dicoms_done$V1)

} else {
   dicoms_done <- 0
   dicoms_to_process <- setdiff(dicoms, dicoms_done)

}

```



# Main step 2: Nii conversion

here a loop reads in the dicoms (that dont have the suffix "_done") and converts them. Then changes the folder name to "_done".

Anonymized nii images will be outputted

#### flags

-ba y or n - turns on BIDS and anonymization
-o "path" - gives the output path
-z - turns on conversion
-f - filename information

```{r}

# Creation of pathnames for temporary output
nii_temp_path <- str_replace(dicoms_to_process, "dicom", "nii_temp") %>%
  str_replace(regex(",bidirect|_bidirect", ignore_case = TRUE), "")

# Creation of folders
lapply(nii_temp_path, dir.create, recursive=TRUE)

# Conversion of Dicom 2 Nifti
for (i in 1:length(dicoms_to_process)) {
  print(dicoms_to_process[i])
  dcm2nii(dicoms_to_process[i], 
          copy_files = FALSE,
          opts = paste0("-ba y ", "-o ", nii_temp_path[i], " -z y", " -f %d"))
  
}


write.table(dicoms_to_process, "dcm_converted.txt", row.names = FALSE, col.names = FALSE)

```

## Now that your files are converted and anonymized we take care of getting the data into the BIDS format and move them from the nii_temp folder to the nii folder.

# Step 3: BIDS formatting and moving

## Indexing of files (json and nii.gz)

```{r}
nii_temp_path <- list.files("nii_temp", 
                     recursive = TRUE,
                     full.names = TRUE)

```


#### Extraction of sequence patterns

```{r}
# This is quality control of how your sequences are named (after removing of additional tags)
str_to_remove = "36Jones20|TFElrsQFOV|fMRsshp|Patient_Aligned_MPR_AWPLAN_|_-_WIP_|_TYPE_BRAIN_|MST_|_Blut"


sequences_used <-nii_temp_path %>% 
  str_replace(".json|.nii.gz", "") %>%
  str_replace_all(str_to_remove, "") %>%
  str_split_fixed("/", n = 4)
  
unique(sequences_used[,4]) %>% sort()
```

# Here you need to manually fit the timepoint and sequence names to your study

__EDITING NEEDED__ based on your file structure

```{r}

sequence_types <- c("anat/T1w", "anat/T1w_TFEmod", "anat/T2w", "anat/T2mod", "anat/T2star", "anat/FLAIR", "anat/FLAIR_VISTA",
                               "func/rest_133", "func/epi_bold",
                               "dwi/isoRegDTI", "dwi/faRegDTI" , "dwi/dRegDTI", "dwi/facRegDTI", "dwi/RegDTI", "dwi/DTI",
                               "other/smartplan", "other/survey", "other/smartbrain")

sequence_to_rename <- c("3DT1", "T1W_TFE", "T2W_TSE", "T2mod", "T2_FFE", "FLAIR_TE120", "FLAIR_VISTA",
                        "RS133", "emotional_faces",
                        "isoRegDTI", "faRegDTI" , "dRegDTI", "facRegDTI", regex("^RegDTI"), "^DTI",
                        "SMARTPLAN", "survey", "SmartBrain")

timepoints <- list(new = c("ses1", "ses2", "ses3", "ses3_plus", "ses4", "ses4_plus"),
                   old = c("Baseline", "FollowUp1", "FollowUp2", "FollowUp2_plus", "FollowUp3", "FollowUp3_plus"))

```

```{r}
# Output of unique sequence names
unique(sequences_used[,4]) %>%
  str_replace_all(str_to_remove, "") %>%
  stri_replace_all_fixed(regex(sequence_to_rename), sequence_types, vectorize_all = FALSE) %>%
  str_replace_all("^RegDTI", "dwi/RegDTI") %>%
  str_replace_all("^DTI", "dwi/DTI") %>%
  sort()
```

## Generating new BIDS file paths

```{r}
sequence_BIDS <- nii_temp_path %>%
  stri_replace_all_fixed(timepoints$old, timepoints$new, vectorize_all = FALSE) %>%
  str_replace_all(str_to_remove, "") %>%
  stri_replace_all_fixed(sequence_to_rename, sequence_types, vectorize_all = FALSE) %>%
  str_replace_all("(?<=/)RegDTI", "dwi/RegDTI") %>%
  str_replace_all("(?<=/)DTI", "dwi/DTI") %>%
  str_replace_all("nii_temp", "nii") %>%
  str_split_fixed("/", n = 4)
  
sequence_BIDS <- paste(sequence_BIDS[,1], sequence_BIDS[,3], sequence_BIDS[,2], sequence_BIDS[,4], sep = "/")
```

## QC: converted_files.csv creation!

```{r}
# Comparison of original path and renamed version  
mapping_list <- cbind(nii_temp_path, sequence_BIDS)


if (file.exists("converted_files.csv") == 0) {
  print("Mapping does not exist - writing file")
  write.csv(mapping_list, "converted_files.csv", row.names = FALSE)
  
} else {
  print("Other mapping was found 'converted_files.csv'. File opened, additional information added.")
  read.csv("converted_files.csv", stringsAsFactors = FALSE) %>% 
    rbind(mapping_list) %>%
    write.csv("converted_files.csv", row.names = FALSE)
  
}

head(mapping_list)
```



# Step 3: copying of files and renaming

```{r}

# Regex for identifying folders to create
BIDS_folders <- gsub("(.*)/.*","\\1", sequence_BIDS) %>% unique()

i = 0

for (i in 1:length(BIDS_folders)){
  print(i)
  dir.create(BIDS_folders[i], recursive = TRUE)
}

# Reorder the files to the new folders
file.rename(mapping_list[,1], mapping_list[,2])

# Delete 'nii_temp' folder
unlink("nii_temp", recursive = TRUE)
```





