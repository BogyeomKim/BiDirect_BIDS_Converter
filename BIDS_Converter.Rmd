---
title: "BD_BIDS_Converter"
author: "Niklas Wulms"
date: "7/4/2019"
output: html_document
---

#### optional: libraries to install

```{r eval=FALSE}
install.packages("stringr")
install.packages("tidyverse")
install.packages("devtools")
devtools::install_github("muschellij2/dcm2niir")
```

```{r eval=FALSE}
install_dcm2nii(lib.loc=NULL, overwrite = FALSE, from_source = TRUE, jpeg = FALSE, progdir = NULL)
```

#### load libraries

```{r}
library(stringr)
library(tidyr)
library(devtools)
library(dcm2niir)
library(stringi)
library(dplyr)

library(rpivotTable)

```



# set here your start folder

```{r}
rm(list=ls())
working_dir <- ("/media/niklas/My Book/Bidirect_Dicom/") 

# working_dir <- ("/media/niklas/spaceC/BIDS_Convert_test")
```

Working directory is set here

```{r setup}
require(knitr)
knitr::opts_knit$set(root.dir = working_dir)

```


#### Indexing of dicom images

compare which folders are done and which are not done.

We need to identify combinations of _timepoint x subject_id_ out of the folder _dicom_ and _nii_

```{r}



dicoms <- dir("dicom", full.names = TRUE)

dicoms <- unlist(lapply(dicoms, FUN = dir, 
                 recursive = FALSE, 
                 full.names = TRUE)) 
```



```{r}
# converted dicoms rausfiltern auslesen!
if (file.exists("dcm_converted.txt") == 1) {
  print("Reading in already converted dicom files")
  dicoms_done <- read.table("dcm_converted.txt", stringsAsFactors = FALSE, header = TRUE)
  dicoms_to_process <- setdiff(dicoms, dicoms_done$dicoms)
  dicoms <- dicoms_done$dicoms
  
} else {
  print("No dcm_converted.txt file found. New file will be created")
   dicoms_to_process <- dicoms
}

writeLines(c(paste("Dicom folders to process: ", length(dicoms_to_process))))
writeLines(c(paste("Already converted folders:", length(dicoms))))
  
# Creation of pathnames for temporary output / Cleaning of filenames (stringr package)
nii_temp_path <- str_replace(dicoms_to_process, "dicom", "nii_temp") %>%
  str_replace_all(regex("bidirect_plus|bidirect-plus|bidiect_plus", ignore_case = TRUE), "") %>%
  str_replace(regex("_bidirect|bidirect", ignore_case = TRUE), "") %>%
  str_replace(regex("bibirect|didirect|_bidrect|bi direct|bdirect|bi_direct", ignore_case = TRUE), "") %>%
  str_replace(regex(", |,_|,,|,|\\.|\\__"), "") %>%
  str_replace(regex("10646_plus", ignore_case = TRUE), "10646") %>%
  str_replace("30224neu", "30224") %>%
  str_replace("30250_incl DIR-Sequenz", "30250") %>%
  str_replace_all(regex("plus", ignore_case = TRUE), "plus")


dicoms_mapping <- cbind(dicoms_to_process, nii_temp_path, deparse.level = 0)
dicoms_mapping <- data.frame(dicoms = dicoms_to_process,
                             nii_temp = nii_temp_path,
                             stringsAsFactors = FALSE)

write.table(dicoms_mapping, "mapping_dicom.txt", row.names = FALSE, col.names = FALSE)

print("Unique identifiers - you should find here only folder names of sessions!")

dicoms_mapping$nii_temp %>% 
  str_replace("[:digit:]{5}", "") %>%
  unique() %>%
  data.frame()

# inspect these scans! longer filenames!
dicoms_mapping$nii_temp %>%
  str_subset(pattern = "/[:digit:]{5}$", negate = TRUE) %>%
  data.frame()



```


# Main step 2: Nii conversion

here a loop reads in the dicoms (that dont have the suffix "_done") and converts them. Then changes the folder name to "_done".

Anonymized nii images will be outputted

#### flags

-ba y or n - turns on BIDS and anonymization
-o "path" - gives the output path
-z - turns on conversion
-f - filename information

```{r}
# Conversion of Dicom 2 Nifti
for (i in 1:length(dicoms_mapping$dicoms)) {
  print(paste("File " ,i, " of ", length(dicoms_mapping$dicoms), " files processed"))

  print(paste("Old name: ", dicoms_mapping$dicoms[i], "converted to new name: ", dicoms_mapping$nii_temp[i]))
  
  # Creation of folders
  dir.create(dicoms_mapping$nii_temp[i], recursive=TRUE, showWarnings = FALSE)
  
  dcm2nii(dicoms_mapping$dicoms[i], 
          copy_files = FALSE, merge_files = TRUE, ignore_derived = FALSE, dcm2niicmd = "dcm2niix", 
          opts = paste0("-ba y ", "-o ", dicoms_mapping$nii_temp[i], " -z y", " -f %d"))
  
  if (length(dicoms_mapping$dicoms[i]) > 0) {
  
    if (file.exists("dcm_converted.txt") == 1) {
      dicoms <- read.table("dcm_converted.txt", stringsAsFactors = FALSE, header = TRUE)
      # print("Old dicoms")
      # print(dicoms)
      # print("New dicoms")
      # print(dicoms_mapping[i,])
      dicoms <- rbind(dicoms, dicoms_mapping[i,])
    } else {
      # print(dicoms_mapping[i,])
      dicoms <- dicoms_mapping[i,]
      # print("no dcm_converted.txt")
      # print(dicoms)
    }
    write.table(dicoms, "dcm_converted.txt", row.names = FALSE, col.names = TRUE)
  }
}
```

## Test chunk batch loop

not needed now

```{r eval=FALSE}
for (i in 1:10:length(dicoms_mapping)) {
  
}


for (i in seq(1, length(dicoms_mapping$dicoms), 10)) {
  print(i)
    a = (seq(i, i+9))
  
  print(paste("This is batch ", i, " of ", length(dicoms_mapping$dicoms)/10))
  
  for (j in 1:length(a)){

    print(paste(a[j], " data: ", dicoms_mapping$dicoms[a[j]]))
  }
}
```


## Now that your files are converted and anonymized we take care of getting the data into the BIDS format and move them from the nii_temp folder to the nii folder.

# Step 3: BIDS formatting and moving

## Indexing of files (json and nii.gz)

```{r}
nii_temp_path <- list.files("nii_temp", 
                     recursive = TRUE,
                     full.names = TRUE)

```


#### Extraction of sequence patterns

```{r}
# This is quality control of how your sequences are named (after removing of additional tags)
str_to_remove = "i000|36Jones20|TFElrsQFOV|fMRsshp|Patient_Aligned_|AWPLAN_|_-_WIP_|_TYPE_BRAIN_|MST_|_Blut|_-_|VWIP_|dcm2nii_"


sequences_used <-nii_temp_path %>% 
  str_subset(".nii.gz") %>%
  str_replace_all(str_to_remove, "") %>%
  str_split_fixed("/", n = 4)
  
(seq_used_uniq <- unique(sequences_used[,4]) %>% sort())

```

```{r}
nii_temp_df <- nii_temp_path %>%
  str_subset(".nii.gz") %>%
  str_split("/", n = 4, simplify = TRUE) %>%
  as.data.frame(stringsAsFactors = FALSE)



names(nii_temp_df)[1] <- "path"
names(nii_temp_df)[2] <- "session" 
names(nii_temp_df)[3] <- "subject"
names(nii_temp_df)[4] <- "sequence"

nii_temp_df$group <- str_sub(nii_temp_df$subject, 1, 1)

nii_temp_df$sequence_clean <- nii_temp_df$sequence %>%
  # assign imaging groups
  str_replace("fMRssh", "/func/rest/") %>%
  str_replace("^(?=[:graph:]*DTI)", "/dwi/DTI/") %>%
  str_replace("^(?=[:graph:]*T1)", "/anat/T1w/") %>%
  str_replace("^(?=[:graph:]*(T2W_TSE))", "/anat/T2w/") %>%
  str_replace("^(?=[:graph:]*(T2_FFE_Blut.nii))", "/anat/T2_star/") %>%
  str_replace("^(?=[:graph:]*(FLAIR_TE120))", "/anat/T2_FLAIR/") %>%
  str_replace("^(?=[:graph:]*(invalidName))", "/other/unknown/") %>%
  str_replace("^(?=[:graph:]*(SURVEY|survey))", "/other/Survey_MST/") %>%
  str_replace("^(?=[:graph:]*(SmartBrain))", "/other/Smartbrain/") %>%
  str_replace("^(?=[:graph:]*(MPR))", "/other/MPR/") %>%
  
  # PLUS sequences
  str_replace()
  str_replace("^(?=[:graph:]*(mFFE_mod))", "/other/mFFE_mod/") %>%
  # remove tags in filenames
  str_replace_all("TFElrs|Jones20n|Patient_Aligned_|SMARTPLAN_TYPE_BRAIN_|AWPLAN_|VWIP_|WIP_|dcm2nii_|_TE120|36", "") %>%
  str_replace("_-_", "_")



nii_temp_df$image_classes <- nii_temp_df$sequence_clean %>%
  str_extract("/.*/") 

nii_temp_df$plausible <- ifelse(nii_temp_df$sequence_clean %in% c("/anat/T1w/3DT1QFOV.nii.gz", 
                                                                  "/anat/T2_FLAIR/FLAIR.nii.gz",
                                                                  "/anat/T2_star/T2_FFE_Blut.nii.gz",
                                                                  "/anat/T2w/T2W_TSE.nii.gz",
                                                                  
                                                                  "/dwi/DTI/DTI.nii.gz",
                                                                  "/dwi/DTI/Reg_DTI.nii.gz",
                                                                  "/dwi/DTI/dReg_DTI.nii.gz",
                                                                  "/dwi/DTI/faReg_DTI.nii.gz",
                                                                  "/dwi/DTI/facReg_DTI.nii.gz",
                                                                  "/dwi/DTI/isoDTI_Maske0.nii.gz",
                                                                  "/dwi/DTI/isoReg_DTI.nii.gz",
                                                                  
                                                                  "/func/rest/2s35_82.nii.gz",
                                                                  "/func/rest/pRS72.nii.gz",
                                                                  "/func/rest/pRS133.nii.gz",
                                                                  
                                                                  "/other/MPR/MPR_i00001.nii.gz",
                                                                  "/other/MPR/MPR_i00023.nii.gz",
                                                                  "/other/MPR/MPR_i00039.nii.gz",
                                                              
                                                                  "/other/Smartbrain/SmartBrain.nii.gz",
                                                                  "/other/Smartbrain/SmartBrain_i00001.nii.gz",
                                                                  "/other/Smartbrain/SmartBrain_i00002.nii.gz",
                                                                  
                                                                  # PLUS sequences
                                                                  "/other/mFFE_mod/mFFE_mod_e1.nii.gz",
                                                                  "/other/mFFE_mod/mFFE_mod_e1_ph.nii.gz",
                                                                  "/other/mFFE_mod/mFFE_mod_e2.nii.gz",
                                                                  "/other/mFFE_mod/mFFE_mod_e2_ph.nii.gz",
                                                                  "/other/mFFE_mod/mFFE_mod_e3.nii.gz",
                                                                  "/other/mFFE_mod/mFFE_mod_e3_ph.nii.gz",
                                                                  "/other/mFFE_mod/mFFE_mod_e4.nii.gz",
                                                                  "/other/mFFE_mod/mFFE_mod_e4_ph.nii.gz",
                                                                  "/other/mFFE_mod/mFFE_mod_e5.nii.gz",
                                                                  "/other/mFFE_mod/mFFE_mod_e5_ph.nii.gz",
                                                                  "/other/mFFE_mod/mFFE_mod_e6.nii.gz",
                                                                  "/other/mFFE_mod/mFFE_mod_e6_ph.nii.gz",
                                                                  "/other/mFFE_mod/mFFE_mod_e7.nii.gz",
                                                                  "/other/mFFE_mod/mFFE_mod_e7_ph.nii.gz",
                                                                  
                                                                  "/anat/T1w/3DT1TFEmod.nii.gz",
                                                                  "/anat/T1w/3DT1TFEmod_cor_1_0.nii.gz",
                                                                  "/anat/T1w/3DT1TFEmod_tra_1_0.nii.gz",
                                                                  "/anat/T2_FLAIR/FLAIR_VISTA.nii.gz",
                                                                  "/anat/T2_FLAIR/FLAIR_VISTA_cor_1_0.nii.gz",
                                                                  "/anat/T2_FLAIR/FLAIR_VISTA_tra_1_0.nii.gz",
                                                                  "/anat/T2w/T2_TSE_2mm.nii.gz"
                                                                  
                                                                  ), 
                                "plausible", "not plausible")

nii_temp_df %>%
  select(sequence, sequence_clean) %>%
  arrange(sequence_clean) %>%
  unique()



nii_temp_df %>%
 # filter(session != "FollowUp2_plus") %>%
  rpivotTable(rows = c("plausible", "image_classes", "sequence_clean", "sequence"),
            cols = c("session", "group"))

nii_temp_df %>%
  group_by(plausible, sequence_clean) %>%
  tally()
```



# Here you need to manually fit the timepoint and sequence names to your study

__EDITING NEEDED__ based on your file structure

```{r}

sequence_types <- list(new = c("anat/T1w", "anat/T1w_TFEmod", "anat/T2w", "anat/T2mod", "anat/T2star", "anat/FLAIR", "anat/FLAIR_VISTA",
                               "func/rest_133", "func/epi_bold",
                               "dwi/isoRegDTI", "dwi/faRegDTI" , "dwi/dRegDTI", "dwi/facRegDTI", "dwi/RegDTI", "dwi/DTI",
                               "other/smartplan", "other/survey", "other/smartbrain"),
                       old = c("3DT1", "T1W_TFE", "T2W_TSE", "T2mod", "T2_FFE", "FLAIR_TE120", "FLAIR_VISTA",
                        "RS133", "emotional_faces",
                        "isoRegDTI", "faRegDTI" , "dRegDTI", "facRegDTI", regex("^RegDTI"), "^DTI",
                        "SMARTPLAN", "survey", "SmartBrain"))

timepoints <- list(new = c("ses1", "ses2", "ses3", "ses3_plus", "ses4", "ses4_plus"),
                   old = c("Baseline", "FollowUp1", "FollowUp2", "FollowUp2_plus", "FollowUp3", "FollowUp3_plus"))

sequence_types %>%
  data.frame(stringsAsFactors = FALSE) %>%
  arrange(new)

timepoints %>%
  data.frame(stringsAsFactors = FALSE)
  arrange(new)

```

```{r}
# Output of unique sequence names
seq_new_uniq <- seq_used_uniq %>%
  str_replace_all(str_to_remove, "") %>%
  stri_replace_all_fixed(sequence_types$old, sequence_types$new, vectorize_all = FALSE) %>%
  str_replace_all("DTIn", "DTI") %>%
  str_replace_all("^RegDTI", "dwi/RegDTI") %>%
  str_replace_all("^DTI", "dwi/DTI")

mapping_sequences <- data.frame(old = seq_used_uniq, new = seq_new_uniq, stringsAsFactors = FALSE) %>%
  arrange(new)

mapping_sequences %>%
  arrange(new)


```

```{r}
if (file.exists("mapping_sequences.txt") == 1) {
  print("Reading in already existing mapping")
  mapping_sequences_old <- read.table("mapping_sequences.txt", stringsAsFactors = FALSE, header = TRUE, fill=TRUE)
  mapping_sequences_diff <- setdiff(mapping_sequences, mapping_sequences_old)
  print(paste("Appending ", length(mapping_sequences_diff), " files"))
  mapping_sequences <- rbind(mapping_sequences_old, mapping_sequences_diff)
  
} else {
  print("No mapping_sequences.txt file found. New file will be created")
}

write.table(mapping_sequences, "mapping_sequences.txt", row.names = FALSE, col.names = TRUE)

```


## Generating new BIDS file paths

```{r}
sequence_BIDS <- nii_temp_path %>%
  stri_replace_all_fixed(timepoints$old, timepoints$new, vectorize_all = FALSE) %>%
  str_replace_all(str_to_remove, "") %>%
  stri_replace_all_fixed(sequence_types$old, sequence_types$new, vectorize_all = FALSE) %>%
  str_replace_all("(?<=/)RegDTI", "dwi/RegDTI") %>%
  str_replace_all("(?<=/)DTI", "dwi/DTI") %>%
    str_replace_all("DTIn", "DTI") %>%
  str_replace_all("nii_temp", "nii") %>%
  str_split_fixed("/", n = 5)
  
sequence_BIDS <- paste(sequence_BIDS[,1], sequence_BIDS[,3], sequence_BIDS[,2], sequence_BIDS[,4], paste0(sequence_BIDS[,3],"-", sequence_BIDS[,5]), sep = "/")

mapping_BIDS <- data.frame(old = nii_temp_path,
                           new = sequence_BIDS,
                           stringsAsFactors = FALSE)

mapping_BIDS

```

```{r}
if (file.exists("mapping_BIDS.txt") == 1) {
  print("Reading in already existing BIDS mapping")
  mapping_BIDS_old <- read.table("mapping_BIDS.txt", stringsAsFactors = FALSE, header = TRUE)
  mapping_BIDS_diff <- setdiff(mapping_BIDS, mapping_BIDS_old)
  print(paste("Appending ", length(mapping_BIDS_diff$old), " files"))
  mapping_BIDS <- rbind(mapping_BIDS_old, mapping_BIDS_diff)
  
} else {
  print("No mapping_BIDS.txt file found. New file will be created")
}

write.table(mapping_BIDS, "mapping_BIDS.txt", row.names = FALSE, col.names = TRUE)

```


# Step 3: copying of files and renaming

```{r}

# Regex for identifying folders to create
BIDS_folders <- gsub("(.*)/.*","\\1", sequence_BIDS) %>% unique()

i = 0

for (i in 1:length(BIDS_folders)){
  print(i)
  dir.create(BIDS_folders[i], recursive = TRUE)
}

# Reorder the files to the new folders
file.rename(mapping_BIDS$old, mapping_BIDS$new)

print("Moving and renaming done")

# Delete 'nii_temp' folder
if (length(list.files("nii_temp", all.files = TRUE, recursive = TRUE))== 0) {
  unlink("nii_temp", recursive = TRUE)
} else {
  print("nii_temp folder not empty - please take a look at it")
}
```





