---
title: "BD_BIDS_Converter"
author: "Niklas Wulms"
date: "7/4/2019"
output: html_document
---

#### optional: libraries to install

```{r eval=FALSE}
install.packages("stringr")
install.packages("tidyverse")
```


#### load libraries

```{r}
library(stringr)
library(tidyr)
library(stringi)
library(dplyr)
```



# set here your start folder

```{r setup}
rm(list=ls())

# On Linux
working_dir <- ("/media/niklas/My Book/Bidirect_Dicom/") 

# On Windows
# working_dir <- ("H:/Bidirect_Dicom/")

require(knitr)
knitr::opts_knit$set(root.dir = working_dir)
```


# Indexing of dicom images

compare which folders are done and which are not done.

We need to identify combinations of _timepoint x subject_id_ out of the folder _dicom_ and _nii_

```{r}
dicoms <- dir("dicom", full.names = TRUE)

dicoms <- unlist(lapply(dicoms, FUN = dir, 
                 recursive = FALSE, 
                 full.names = TRUE)) 
```

## Preparation of output paths, comparison with already converted dicom images (based on dcm_converted_2.txt)

```{r}
# converted dicoms rausfiltern auslesen!
if (file.exists("dcm_converted.txt") == 1) {
  print("Reading and comparing with already converted dicom files")
  dicoms_done <- read.table("dcm_converted.txt", stringsAsFactors = FALSE, header = TRUE)
  dicoms_to_process <- setdiff(dicoms, dicoms_done$dicoms)
  dicoms <- dicoms_done$dicoms
  
} else {
  print("No dcm_converted.txt file found. New file will be created")
   dicoms_to_process <- dicoms
}

writeLines(c(paste("Dicom folders to process: ", length(dicoms_to_process))))
writeLines(c(paste("Already converted folders:", length(dicoms))))
  
# Creation of pathnames for temporary output / Cleaning of filenames (stringr package)
nii_temp_path <- str_replace(dicoms_to_process, "dicom", "nii_temp_2") %>%
  str_replace_all(regex("bidirect_plus|bidirect-plus|bidiect_plus", ignore_case = TRUE), "") %>%
  str_replace(regex("_bidirect|bidirect", ignore_case = TRUE), "") %>%
  str_replace(regex("bibirect|didirect|_bidrect|bi direct|bdirect|bi_direct", ignore_case = TRUE), "") %>%
  str_replace(regex(", |,_|,,|,|\\.|\\__"), "") %>%
  str_replace(regex("10646_plus", ignore_case = TRUE), "10646") %>%
  str_replace("30224neu", "30224") %>%
  str_replace("30250_incl DIR-Sequenz", "30250") %>%
  str_replace_all(regex("plus", ignore_case = TRUE), "plus") %>%
  str_replace("10738eigentlich_|_RS|RS|T2TSE|ABBRUCH", "")


dicoms_mapping <- cbind(dicoms_to_process, nii_temp_path, deparse.level = 0)
dicoms_mapping <- data.frame(dicoms = dicoms_to_process,
                             nii_temp = nii_temp_path,
                             stringsAsFactors = FALSE)

write.table(dicoms_mapping, "mapping_dicom2.txt", row.names = FALSE, col.names = FALSE)

print("Unique identifiers - you should find here only folder names of sessions!")

dicoms_mapping$nii_temp %>% 
  str_replace("[:digit:]{5}", "") %>%
  unique() %>%
  data.frame()

# inspect these scans! longer filenames!
dicoms_mapping$nii_temp %>%
  str_subset(pattern = "/[:digit:]{5}$", negate = TRUE) %>%
  data.frame()

dicoms_mapping



```


# Main step 2: Nii conversion

here a loop reads in the dicoms (that dont have the suffix "_done") and converts them. Then changes the folder name to "_done".

Anonymized nii images will be outputted

#### flags

-ba y or n - turns on BIDS and anonymization
-o "path" - gives the output path
-z - turns on conversion
-f - filename information


```{r}
setwd(working_dir)
system(paste0("cd ", paste0("'", working_dir, "'")))
system("dir")
```


```{r}
library(tictoc)
# Conversion of Dicom 2 Nifti
for (i in 1:length(dicoms_mapping$dicoms)) {
#for (i in 1:2) {
  if (i %% 10 == 0) {
    cat("\014")
  }
  toc()
  tic()
  print(paste("File " ,i, " of ", length(dicoms_mapping$dicoms), " files processed"))

  print(paste("Old name: ", dicoms_mapping$dicoms[i], "converted to new name: ", dicoms_mapping$nii_temp[i]))
  
  # Creation of folders
  dir.create(dicoms_mapping$nii_temp[i], recursive=TRUE, showWarnings = FALSE)

  

  system_string <- paste0("dcm2niix ",
                          "-ba n ",
                          "-x y ", # crop 3d 
                          "-o ", dicoms_mapping$nii_temp[i], " ",
                          "-z y ",
                          "-i n ", # ignore derived
                          "-v n ", # verbose turned off
                          "-w 0 ", # skips overwriting when name is conflicting
                          "-f %d ", 
                          dicoms_mapping$dicoms[i])
  
  system(system_string)
    
  
  
  if (length(dicoms_mapping$dicoms[i]) > 0) {
  
    if (file.exists("dcm_converted.csv") == 1) {
      
      write.table(dicoms_mapping[i,],
                "dcm_converted.csv",
                sep = ",",
                dec = ".",
                qmethod = "double",
                row.names = FALSE,
                append = TRUE,
                col.names = FALSE)
   
    } else {
      dicoms <- dicoms_mapping[i,]
      
            write.table(dicoms_mapping[i,],
                "dcm_converted.csv",
                sep = ",",
                dec = ".",
                qmethod = "double",
                row.names = FALSE)
    
    }
  }
}
```

```{r}
file.exists(dicoms_mapping$dicoms[1])
getwd()
```






